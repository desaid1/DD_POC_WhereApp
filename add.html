<!-- add.html (Version 20250629193500 IST - Final UI with Smart Location Picker) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Add Version 10.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script defer src="apps/locationPicker.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      max-width: 700px;
      margin: 30px auto;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 12px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    label {
      font-weight: bold;
    }
    input, select, button, textarea {
      width: 100%;
      margin-top: 6px;
      margin-bottom: 16px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background: #2d89ef;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #1b61c1;
    }
    .row { display: flex; gap: 10px; align-items: center; }
    .row input { flex: 1; }
    .flex-list, .media-list { margin-bottom: 20px; }
    .section { margin-bottom: 24px; }
    .toggle-tab {
      display: inline-block;
      padding: 6px 18px;
      border-radius: 20px;
      border: 1px solid #ccc;
      margin: 0 6px;
      background: #eee;
      cursor: pointer;
    }
    .toggle-tab.active {
      background: #2d89ef;
      color: white;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>➕ Add Version 10.2</h2>

  <div class="section">
    <label for="thing-name">Thing Name</label>
    <input id="thing-name" placeholder="e.g. Star Agro: Tomato" />
  </div>

  <div class="section">
    <label>Visibility</label>
    <div class="row" id="visibility-tabs">
      <div class="toggle-tab active" data-value="group">Group</div>
      <div class="toggle-tab" data-value="public">Public</div>
    </div>
  </div>

  <div class="section">
    <label><input type="checkbox" id="isLocationSource" /> Mark this Thing as a Location Source</label>
  </div>

  <div id="location-section" class="section"></div>

  <div class="section">
    <label>Flexibutes</label>
    <div id="flex-list" class="flex-list"></div>
    <button type="button" onclick="addFlexField()">➕ Add Detail</button>
  </div>

  <div class="section">
    <label>Media Links</label>
    <div id="media-list" class="media-list"></div>
    <button type="button" onclick="addMediaField()">➕ Add Media</button>
  </div>

  <button onclick="submitThing()">✅ Submit</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAatek1caogYhCY0rXj9YrGC32E0lRJtUs",
      authDomain: "whereapp-ideasdesai.firebaseapp.com",
      projectId: "whereapp-ideasdesai"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userId = null;
    let visibility = "group";

    auth.signInAnonymously().then(res => {
      userId = res.user.uid;
      if (typeof window.loadLocationPicker === 'function') {
        window.loadLocationPicker("location-section", userId, db);
      }
    });

    function addFlexField(key = '', value = '') {
      const container = document.getElementById("flex-list");
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `<input placeholder="Key" value="${key}"><input placeholder="Value" value="${value}">`;
      container.appendChild(row);
    }

    function addMediaField(link = '') {
      const container = document.getElementById("media-list");
      const input = document.createElement("input");
      input.placeholder = "Paste image/document URL...";
      input.value = link;
      container.appendChild(input);
    }

    document.getElementById("visibility-tabs").addEventListener("click", e => {
      if (e.target.classList.contains("toggle-tab")) {
        document.querySelectorAll(".toggle-tab").forEach(t => t.classList.remove("active"));
        e.target.classList.add("active");
        visibility = e.target.dataset.value;
      }
    });

    function submitThing() {
      const name = document.getElementById("thing-name").value.trim();
      const isLocationSource = document.getElementById("isLocationSource").checked;
      const location = window.getSelectedLocation ? window.getSelectedLocation() : null;

      const details = {};
      document.querySelectorAll("#flex-list .row").forEach(row => {
        const inputs = row.querySelectorAll("input");
        if (inputs[0].value && inputs[1].value) {
          details[inputs[0].value.trim()] = inputs[1].value.trim();
        }
      });

      const media = Array.from(document.querySelectorAll("#media-list input"))
                        .map(i => i.value.trim()).filter(x => x);

      const data = {
        name,
        userId,
        visibility,
        isLocationSource,
        createdAt: new Date().toISOString(),
        flexibutes: details,
        media
      };

      if (location) {
        data.lat = location.lat;
        data.long = location.long;
      }

      db.collection("things").add(data).then(() => {
        alert("✅ Thing added successfully!");
        location.reload();
      }).catch(err => {
        console.error("Error saving thing:", err);
        alert("❌ Failed to save. Check console.");
      });
    }

    addFlexField();
    addMediaField();
  </script>
</body>
</html>
