<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>WhereApp – Simplifying Sustainability</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Nunito Sans', sans-serif;
      background: #202124;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 60px;
    }
    h1 {
      font-size: 48px;
    }
    input[type="text"] {
      width: 90%;
      max-width: 500px;
      padding: 12px 16px;
      font-size: 16px;
      border-radius: 30px;
      border: none;
      margin: 20px 0;
    }
    .apps, .score, .results, .log {
      width: 90%;
      max-width: 600px;
      margin-bottom: 20px;
    }
    .apps button {
      margin: 5px;
      padding: 10px 14px;
      border-radius: 20px;
      border: none;
      background: #5f6368;
      color: white;
      cursor: pointer;
    }
    .thing {
      background: #303134;
      padding: 14px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .thing h3 {
      margin: 0 0 8px;
      color: #fff;
    }
    .thing p {
      margin: 2px 0;
      color: #ccc;
    }
    .media-img {
      max-width: 100px;
      margin: 4px;
      border-radius: 4px;
    }
    .edit-btn {
      margin-top: 10px;
      background: #4285f4;
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<h1>WhereApp</h1>
<input type="text" id="searchInput" placeholder="Search or trigger..." oninput="renderThings()" />
<div class="apps" id="buttons"></div>
<div class="score" id="score"></div>
<div class="results" id="thingsList"></div>
<div class="log" id="log"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAatek1caogYhCY0rXj9YrGC32E0lRJtUs",
    authDomain: "whereapp-ideasdesai.firebaseapp.com",
    projectId: "whereapp-ideasdesai"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  let userId = null;
  let allThings = [];
  let score = 0;
  let currentLat = null;
  let currentLong = null;

  auth.signInAnonymously().then(res => {
    userId = res.user.uid;
    fetchThings();
    loadApps();
  });

  async function fetchThings() {
    const snapshot = await db.collection("things").get();
    allThings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderThings();
  }

  function renderThings() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const container = document.getElementById('thingsList');
    container.innerHTML = '';

    const filtered = allThings.filter(t => {
      const nameMatch = t.name?.toLowerCase().includes(query);
      const flexMatch = Array.isArray(t.flexibutes)
        ? t.flexibutes.some(({ key, val }) => key?.toLowerCase().includes(query) || val?.toLowerCase().includes(query))
        : Object.entries(t.flexibutes || {}).some(([k, v]) => k?.toLowerCase().includes(query) || v?.toLowerCase().includes(query));
      return nameMatch || flexMatch;
    });

    if (filtered.length === 0) {
      container.innerHTML = '<p style="color:#aaa">No matching things found.</p>';
      return;
    }

    filtered.forEach(thing => {
      const div = document.createElement('div');
      div.className = 'thing';

      const mediaImages = (thing.media || [])
        .filter(m => m.includes("http"))
        .map(m => `<img src="${m}" class="media-img">`)
        .join('');

      const details = Array.isArray(thing.flexibutes)
        ? thing.flexibutes.map(({ key, val }) => `<p><strong>${key}:</strong> ${val}</p>`).join('')
        : Object.entries(thing.flexibutes || {}).map(([k, v]) => `<p><strong>${k}:</strong> ${v}</p>`).join('');

      div.innerHTML = `
        <h3>${thing.name || 'Untitled Thing'}</h3>
        ${mediaImages}<br>
        ${details}
        <p><strong>Location:</strong> ${thing.location?.source || 'Unknown'} (${thing.location?.lat}, ${thing.location?.long})</p>
        <p><strong>Visibility:</strong> ${thing.visibility || 'private'}</p>
        <button class="edit-btn" onclick="location.href='edit.html?id=${thing.id}'">✏️ Edit</button>
      `;

      container.appendChild(div);
    });
  }

  function getLocation(callback) {
    if (!navigator.geolocation) {
      alert("Geolocation not supported");
      return;
    }
    navigator.geolocation.getCurrentPosition(pos => {
      currentLat = pos.coords.latitude.toFixed(5);
      currentLong = pos.coords.longitude.toFixed(5);
      callback();
    }, err => {
      alert("Location access denied.");
    });
  }

  function logAction(action) {
    const logDiv = document.getElementById("log");
    const timestamp = new Date().toLocaleTimeString();
    logDiv.innerHTML += `[${timestamp}] ${action}<br>`;
  }

  function logToFirestore(appId, scoreDelta) {
    db.collection("interactions").add({
      userId: userId,
      appId: appId,
      scoreAdded: scoreDelta,
      lat: currentLat,
      long: currentLong,
      timestamp: new Date()
    }).catch(console.error);
  }

  function updateScoreDisplay() {
    document.getElementById("score").innerText = `Score: ${score}`;
  }

  async function loadApps() {
    const files = ["owl", "unicorn", "hello"];
    const apps = await Promise.all(
      files.map(async id => {
        const res = await fetch(`apps/${id}.json`);
        const app = await res.json();
        return app;
      })
    );
    renderButtons(apps);
  }

  function renderButtons(apps) {
    const container = document.getElementById("buttons");
    container.innerHTML = "";
    apps.forEach(app => {
      const btn = document.createElement("button");
      btn.textContent = app.label;
      btn.onclick = () => {
        const run = () => {
          score += app.score;
          updateScoreDisplay();
          logToFirestore(app.id, app.score);

          if (app.whatsappMessage) {
            let message = app.whatsappMessage
              .replace("{{score}}", score)
              .replace("{{lat}}", currentLat)
              .replace("{{long}}", currentLong);

            if (message.includes("{{mapLink}}")) {
              const mapUrl = `https://maps.google.com/?q=${currentLat},${currentLong}`;
              message = message.replace("{{mapLink}}", mapUrl);
            }

            const encoded = encodeURIComponent(message);
            window.open(`https://wa.me/?text=${encoded}`);
            logAction(`${app.label} shared on WhatsApp.`);
          } else {
            logAction(`${app.label} clicked. (+${app.score}) at ${currentLat}, ${currentLong}`);
          }
        };

        if (app.useLocation) {
          getLocation(run);
        } else {
          run();
        }
      };
      container.appendChild(btn);
    });
  }

  updateScoreDisplay();
</script>
</body>
</html>
